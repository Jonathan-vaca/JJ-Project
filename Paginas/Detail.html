<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Publication Details</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/png" href="/components/Logos/logo blanco.png">

  <!-- Header CSS -->
  <link rel="stylesheet" href="/Header/header.css">
  <link rel="stylesheet" href="/footer/footer.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
/* Fondo principal con imagen (PC / Tablet) */
body {
  margin: 0;
  padding: 0;
  font-family: 'Open Sans', sans-serif;
  min-height: 100vh;
  color: #fff;
  background-color: #000000;
  background-image: url('/components/Images/prueba1.jpeg');
  background-repeat: repeat;   
  background-size: contain;    
  background-position: center;
  position: relative;
}

/* Overlay semitransparente */
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  pointer-events: none;
  z-index: -1;
}

/* En m√≥vil, quitar imagen y overlay */
@media screen and (max-width: 768px) {
    body {
        background-image: url('/components/Images/bgprueba.png') !important; /* ‚úÖ Imagen para m√≥vil */
        background-repeat: repeat;   /* üîÑ Repite la imagen */
        background-size: contain;    /* Ajusta para que se repita completa */
        background-position: center; /* Centrada */
        background-color: #000000 !important; /* Color de respaldo */
    }

    body::before {
        display: none !important; /* ‚ùå Quita overlay en m√≥vil */
    }
}

.container { 
  max-width: 700px; 
  margin: 0 auto; 
  padding: 10px; 
}

.card {
  background: rgba(20, 20, 20, 0.85);
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  backdrop-filter: blur(6px);
}

/* Formulario */
textarea, select {
  width: 100%; 
  padding: 6px; 
  border-radius: 6px;
  background: rgba(15, 15, 15, 0.7); 
  border: 1px solid #444; 
  color: #fff;
  margin: 6px 0; 
  resize: none;
  font-size: 0.9rem;
}

button {
  padding: 6px 12px; 
  border-radius: 6px;
  background: rgba(255, 77, 77, 0.9); 
  color: #fff; 
  border: none; 
  cursor: pointer;
  font-weight: 600; 
  font-size: 0.9rem;
  transition: background 0.2s ease;
  display: block;
  margin: 8px auto 0;
}
button:hover { background: rgba(255, 50, 50, 1); }

/* Comentarios */
.comment {
  background: rgba(30, 30, 30, 0.7);
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 6px;
  border-left: 3px solid #ff4d4d;
  font-size: 0.9rem;
}

.comment-row {
  display: flex;
  gap: 10px;
  align-items: flex-start;
  justify-content: space-between;
}

.comment-body { flex: 1; }
.comment-meta { display:flex; gap:6px; align-items:center; margin-bottom:4px; font-size:0.8rem; }
.comment-meta strong { color: #ff8080; margin-right:4px; }
.comment-meta small { color:#aaa; }
.comment-text { margin:0; white-space: pre-wrap; font-size:0.9rem; }

.comment-actions { display:flex; gap:6px; align-items:center; margin-left:6px; }
.comment-actions button {
  background: rgba(255,255,255,0.06);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.08);
  padding: 4px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
}
.comment-actions button:hover { background: rgba(255,255,255,0.12); }

.stars { color: #ffd700; }

/* Carrusel */
.carousel {
  position: relative;
  width: 100%;
  max-width: 650px;
  margin: 0 auto 12px;
  overflow: hidden;
  border-radius: 8px;
}
.carousel-inner {
  position: relative;
  width: 100%;
  height: 320px; /* mantenemos el alto base */
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.carousel-slide img {
  width: 100%;          /* la imagen llena el ancho */
  height: 100%;         /* ocupa la altura del carrusel */
  object-fit: contain;  /* se adapta sin recortar */
  border-radius: 10px;  /* esquinas redondeadas */
}
.carousel-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  font-size: 1.8rem;
  color: #fff;
  cursor: pointer;
  z-index: 5;
  transition: color 0.3s ease;
}
.carousel-btn:hover { color: #ffd700; }
.prev { left: 8px; }
.next { right: 8px; }

/* Fila del select */
.form-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 6px 0;
}
.form-row label { font-weight: 600; white-space: nowrap; }
.form-row select { width: auto; min-width: 70px; }
.card h2 {
  text-align: center;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: #fff;
  color: #000;
  padding: 20px;
  border-radius: 10px;
  width: 300px;
  text-align: center;
  animation: appear 0.3s ease;
}
@keyframes appear {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.modal .close {
  float: right;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
}
.options {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}
.options button {
  padding: 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
}
.whatsapp { background: #25d366; color: #fff; }
.gmail { background: #db4437; color: #fff; }
.options button:hover { opacity: 0.9; }
</style>
</head>
<body>
  <!-- HEADER -->
  <div id="header-placeholder"></div>

  <!-- MAIN CONTENT -->
  <main class="container">
    <div id="post" class="card">Loading...</div>

    <div class="card">
      <h3>Comments</h3>
      <div id="commentsList"></div>

      <h4>Add comment and rating</h4>
<form id="commentForm">
  <textarea id="commentText" rows="3" placeholder="Your comment" required></textarea>
  <div class="form-row">
    <label for="ratingSelect">Rating:</label>
    <select id="ratingSelect">
      <option value="5" selected>5</option>
      <option value="4">4</option>
      <option value="3">3</option>
      <option value="2">2</option>
      <option value="1">1</option>
    </select>
  </div>
  <button>Send</button>
</form>
    </div>
  </main>

  <!-- FOOTER -->
  <div id="footer-placeholder"></div>

  <!-- Quote Modal -->
  <div id="quoteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Send request with:</h2>
      <div class="options">
        <button onclick="sendWithWhatsApp()" class="whatsapp">üí¨ WhatsApp</button>
        <button onclick="enviarConGmail()" class="gmail">üìß Gmail</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CARGAR HEADER Y FOOTER =====
    fetch("/Header/header.html").then(res=>res.text()).then(data=>{
      document.getElementById("header-placeholder").innerHTML = data;
      const script = document.createElement("script"); script.src="/Header/header.js"; document.body.appendChild(script);
    });
    fetch("/footer/footer.html").then(res=>res.text()).then(data=>{
      document.getElementById("footer-placeholder").innerHTML = data;
      const script = document.createElement("script"); script.src="/footer/footer.js"; document.body.appendChild(script);
    });

    // ===== VARIABLES =====
    const API = '/api/posts';
    const q = new URLSearchParams(location.search);
    const id = q.get('id');
    const token = localStorage.getItem('api_token');
    let currentUser = null;

    if(!id){ document.getElementById('post').innerText = 'No id found in the URL'; }

    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    function loadCurrentUserFromStorage(){
      try {
        const u = localStorage.getItem('usuario');
        if (!u) return null;
        return JSON.parse(u);
      } catch(e){
        return null;
      }
    }

    // ==================
    // CARRUSEL HELPERS
    // ==================
    function normalizeImagePath(url) {
      if(!url) return '';
      if(/^https?:\/\//i.test(url)) return url;
      if(url.startsWith('/')) return url;
      return '/' + url;
    }

    function buildCarousel(images, titulo) {
      if(!images || images.length === 0) return '';
      if(typeof images === 'string') images = [images];

      let slides = images.map((img, i) => `
        <div class="carousel-slide ${i === 0 ? 'active' : ''}">
          <img src="${normalizeImagePath(img)}" alt="${escapeHtml(titulo)}">
        </div>
      `).join('');

      return `
        <div class="carousel">
          <div class="carousel-inner">
            ${slides}
          </div>
          ${images.length > 1 ? `
            <button class="carousel-btn prev">‚ùÆ</button>
            <button class="carousel-btn next">‚ùØ</button>
          ` : ''}
        </div>
      `;
    }

    function initCarousels(){
      document.querySelectorAll(".carousel").forEach(carousel => {
        const slides = carousel.querySelectorAll(".carousel-slide");
        const prevBtn = carousel.querySelector(".prev");
        const nextBtn = carousel.querySelector(".next");
        let index = 0;
        let interval;

        slides.forEach((s, i) => {
          s.style.opacity = i === 0 ? "1" : "0";
          s.style.position = "absolute";
          s.style.top = 0;
          s.style.left = 0;
          s.style.width = "100%";
          s.style.height = "100%";
          s.style.transition = "opacity 1s ease-in-out";
        });

        function showSlide(i) {
          slides[index].style.opacity = "0";
          index = (i + slides.length) % slides.length;
          slides[index].style.opacity = "1";
        }

        function nextSlide() { showSlide(index + 1); }
        function prevSlide() { showSlide(index - 1); }

        if(prevBtn) prevBtn.addEventListener("click", ()=> { prevSlide(); resetInterval(); });
        if(nextBtn) nextBtn.addEventListener("click", ()=> { nextSlide(); resetInterval(); });

        function startInterval() { interval = setInterval(nextSlide, 5000); }
        function resetInterval() { clearInterval(interval); startInterval(); }

        startInterval();
      });
    }

    // ===== CARGAR PUBLICACION =====
    async function loadPost(){
      try {
        const res = await fetch(`${API}/${id}`);
        if(!res.ok) {
          console.error('error loadPost', res.status);
          return document.getElementById('post').innerText = 'Error al cargar';
        }
        const p = await res.json();

        document.getElementById('post').innerHTML = `
          <h2>${escapeHtml(p.titulo)}</h2>
          ${
            (Array.isArray(p.imagenes) && p.imagenes.length > 0)
              ? buildCarousel(p.imagenes, p.titulo)
              : (p.imagen ? `<img src="${normalizeImagePath(p.imagen)}" alt="">` : '')
          }
          <p>${escapeHtml(p.contenido||'')}</p>
          <p>Average: ${p.avgRating ? Number(p.avgRating).toFixed(1) : 'No ratings yet'}</p>

          <button id="btnQuote">üì© Request a quote</button>
        `;

        initCarousels();

        const btn = document.getElementById("btnQuote");
        if(btn){
          btn.addEventListener("click", ()=>{ openModal(); });
        }

      } catch (err) {
        console.error('Exception loadPost', err);
        document.getElementById('post').innerText = 'Error al cargar';
      }
    }

    // ===== Modal functions =====
    function openModal() {
      document.getElementById("quoteModal").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("quoteModal").style.display = "none";
    }
    window.onclick = function(event) {
      const modal = document.getElementById("quoteModal");
      if (event.target === modal) {
        closeModal();
      }
    };

    // Send with WhatsApp
    function sendWithWhatsApp() {
      const phone = "573142851999";
      const title = document.querySelector("#post h2")?.innerText || "Product";
      const text = `Hello, I am interested in the product: ${title}`;
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
      window.open(url, "_blank");
      closeModal();
    }

    // Send with Gmail
    function sendWithGmail() {
      const title = document.querySelector("#post h2")?.innerText || "Product";
      const subject = "Product quote request";
      const body = `Hello, I am interested in the product: ${title}`;
      const url = `https://mail.google.com/mail/?view=cm&fs=1&to=&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(url, "_blank");
      closeModal();
    }

    // ===== RENDER COMENTARIOS =====
    async function loadComments(){
      try {
        const res = await fetch(`${API}/${id}/comments`);
        if(!res.ok){
          const err = await res.json().catch(()=>({error:'error'}));
          alert(err.error || 'Error al cargar comentarios');
          return;
        }
        const comments = await res.json();
        const container = document.getElementById('commentsList');

        if(!Array.isArray(comments) || comments.length === 0){
          container.innerHTML = '<p>No hay comentarios</p>';
          return;
        }

        container.innerHTML = comments.map(c => {
          const canAct = currentUser && (currentUser.id === c.usuario_id || currentUser.rol === 'admin');
          return `
            <div class="comment" data-comment-id="${c.id}" data-owner-id="${c.usuario_id}">
              <div class="comment-row">
                <div class="comment-body">
                  <div class="comment-meta">
                    <strong>${escapeHtml(c.nombre || 'Usuario')}</strong>
                    <small>${escapeHtml(new Date(c.creado_en).toLocaleString())}</small>
                  </div>
                  <p class="comment-text" id="comment-text-${c.id}">${escapeHtml(c.comentario)}</p>
                </div>
                <div class="comment-actions" aria-hidden="${!canAct}">
                  ${canAct ? `<button class="btn-edit" data-id="${c.id}" title="Editar">‚úèÔ∏è</button>
                              <button class="btn-delete" data-id="${c.id}" title="Eliminar">üóëÔ∏è</button>` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch(err){
        console.error('Exception loadComments', err);
        alert('Error loading comment');
      }
    }

    // ===== AGREGAR COMENTARIO =====
    document.getElementById('commentForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!token){
        alert("‚ö†Ô∏è Debes iniciar sesi√≥n para comentar y calificar.");
        const redirectUrl = encodeURIComponent(location.pathname + location.search);
        location.href = "/Paginas/Login.html?redirect=" + redirectUrl;
        return;
      }
      const comentario = document.getElementById('commentText').value;
      const estrellas = parseInt(document.getElementById('ratingSelect').value,10);

      try {
        const res = await fetch(`${API}/${id}/comments`, {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ comentario, estrellas })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          alert(data.error || `Error ${res.status}`);
          return;
        }
        document.getElementById('commentText').value = '';
        await loadComments();
        await loadPost();
      } catch(err){
        console.error('Exception post comment', err);
        alert('Error al guardar comentario');
      }
    });

    // ===== EDITAR / ELIMINAR COMENTARIO =====
    document.getElementById('commentsList').addEventListener('click', async (ev) => {
      const editBtn = ev.target.closest('.btn-edit');
      const delBtn = ev.target.closest('.btn-delete');
      if (editBtn) {
        const commentId = editBtn.dataset.id;
        const textEl = document.getElementById('comment-text-' + commentId);
        const oldText = textEl ? textEl.innerText : '';
        const nuevo = prompt("Editar comentario:", oldText);
        if(!nuevo || !nuevo.trim()) return;
        try {
          const res = await fetch(`${API}/${id}/comments/${commentId}`, {
            method: 'PUT',
            headers: {
              'Content-Type':'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ comentario: nuevo })
          });
          const data = await res.json().catch(()=>({}));
          if(!res.ok){
            alert(data.error || `Error ${res.status}`);
            return;
          }
          await loadComments();
        } catch(err){
          console.error('edit error', err);
          alert('Error al editar comentario');
        }
        return;
      }

      if (delBtn) {
        const commentId = delBtn.dataset.id;
        if(!confirm("¬øEliminar este comentario?")) return;
        try {
          const res = await fetch(`${API}/${id}/comments/${commentId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json().catch(()=>({}));
          if(!res.ok){
            alert(data.error || `Error ${res.status}`);
            return;
          }
          await loadComments();
          await loadPost();
        } catch(err){
          console.error('delete error', err);
          alert('Error al eliminar comentario');
        }
        return;
      }
    });

    // ===== INIT =====
    (async()=>{
      currentUser = loadCurrentUserFromStorage();
      await loadPost();
      await loadComments();
    })();
    function generarMensaje(titulo) {
  return `Hello,

This is (your name), I am interested in a product similar to the one in the publication and I would like to request more information in order to get a quotation.

As a company, we kindly request that you provide your phone number or email so we can communicate with you more effectively. **We would appreciate a prompt response.**

Publication: ${titulo}

Phone number:
Email:
Name: `;
}

    function enviarConGmail() {
  const titulo = document.title || "Detalle de producto";
  const subject = `Quotation Request: ${titulo}`;
  const body = generarMensaje(titulo); // ‚úÖ reutiliza la funci√≥n de quote.js

  const url = `https://mail.google.com/mail/?view=cm&fs=1&to=jchaparrovaca@gmail.com&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.open(url, "_blank");
}

  </script>
</body>
</html>
